IMPORT polytope

IMPORT common


CREDIT gfan
  Gfan is a software package for computing Groebner fans and tropical varieties.
  Copyright by Anders Jensen
  http://www.math.tu-berlin.de/~jensen/software/gfan/gfan.html

# path to gfan
custom $gfan_tropicalbruteforce;

CONFIGURE {
    find_program($gfan_tropicalbruteforce, "gfan_tropicalbruteforce");
}


declare object ToricVariety<Scalar=Rational [ typechecks::is_ordered_field(Scalar) ]> : PolyhedralFan<Scalar>; 

object PolyhedralFan<Rational> {

	auto_cast : ToricVariety<Rational>;

}

object ToricVariety {

	property AFFINE : Bool;

	property PROJECTIVE : Bool;

	rule PROJECTIVE : MAXIMAL_CONES {
		$this->PROJECTIVE = 1;
	}
	
	property SMOOTH = override SMOOTH_FAN;

}

declare object HypersurfaceInTV;

object HypersurfaceInTV {
	
	property EQUATION : Polynomial;

	property EXPONENTS : Matrix<Int>;

	property COEFFICIENTS : Vector<Rational>;

	property TROPICAL : TropicalVariety;

	property TROPICAL_FAN : PolyhedralFan;
	
	rule EQUATION : EXPONENTS, COEFFICIENTS {
		my $nvars = $this->EXPONENTS->cols();
        	my @vars = (map { "x$_" } (1..$nvars) );
        	my $R = new Ring(@vars);
        	$this->EQUATION = new Polynomial($this->EXPONENTS,$this->COEFFICIENTS,$R);
	}

	rule TROPICAL_FAN : EXPONENTS, COEFFICIENTS {
		$this->TROPICAL_FAN = gfan_tropicalbruteforce($this->COEFFICIENTS, $this->EXPONENTS);
	}

}

sub gfan_tropicalbruteforce {
	my ($coefficients, $exponents) = @_;
	my $tempfile=new Tempfile;
	#my $tempfile="test";
	
	# Homogenizing polynomial and preparing to write to file:	
	my $nvars = $exponents->cols();
	my @vars = ( "t" , map { "x$_" } (1..$nvars) );
	my $one = ones_vector<Int>($nvars);
	my $degrees = $exponents*$one;
	my $homog = new Matrix<Int>[[map{maximum($degrees)-$degrees->[$_]} (0..($exponents->rows()-1))]];
	print $homog;
	my $newexp = transpose($homog)|$exponents;
	my $R = new Ring(@vars);
	my $p = new Polynomial($newexp,$coefficients,$R); 
	
	# Writing data to file:
	open(my $input, ">$tempfile.in") or die "Can't create temporary file $tempfile.in: $!";
	print $input "Q[";
	print $input join(",",$R->variables);
	print $input "]{\n";
	print $input $p;
	print $input "\n}";
	print $tempfile;
	close $input;
	
	# Accessing gfan:
	system "$gfan_tropicalbruteforce --xml <$tempfile.in >$tempfile.poly 2>/dev/null";
	
	my $gfan_out= User::load("$tempfile.poly");
	# WARNING: file automatically converted via XSLT to correct F_VECTOR
	return $gfan_out;
}


sub homogenize { 
	my ($in) = @_;
	
}

sub gale_dual{
	# TODO
	return 0;
}
