IMPORT polytope

IMPORT common


declare object ToricVariety<Scalar=Rational [ typechecks::is_ordered_field(Scalar) ]> : PolyhedralFan<Scalar>; 

object PolyhedralFan<Rational> {

	auto_cast : ToricVariety<Rational>;

}

object ToricVariety {

	property AFFINE : Bool;

	property PROJECTIVE : Bool;

	rule PROJECTIVE : MAXIMAL_CONES {
		$this->PROJECTIVE = 1;
	}
	
	property SMOOTH = override SMOOTH_FAN;

}

declare object HypersurfaceInTV;

object HypersurfaceInTV {
	
	property EQUATION : Polynomial;

	property TROPICAL : TropicalVariety;

}

user_function gfan_tropicalbruteforce(Vector,Matrix){
	my ($coefficients, $exponents) = @_;
	my $tempfile=new Tempfile;
	
	# Writing data to file:
	# open(my $input, ">$tempfile.in") or die "Can't create temporary file $tempfile.in: $!";
	# print $input "Q[";
	my $nvars = $exponents->cols();
	my @vars = ( "t" , map { "x$_" } (1..$nvars) );
	print @vars;
	print "\n";
	my $one = new Vector<Int>(map{1} (1..$nvars));
	#print $one;
	my $degrees = $exponents*$one;
	#print $degrees;
	my $homog = new Matrix<Int>[[map{maximum($degrees)-$degrees->[$_]} (0..($nvars-1))]];
	#print $homog;
	#print $homog->cols();
	my $newexp = transpose($homog)|$exponents;
	print "\nNew Exponents:\n";
	print $newexp;
	my $R = new Ring(@vars);
	my $p = new Polynomial($newexp,$coefficients,$R); 
	
	print $p;
	print "The Ring: \n";
	print $R;
	#gfan_print_matrix($tempfile,$M);
	#system "$gfan_secondaryfan --xml <$tempfile.txt >$tempfile.poly 2>/dev/null";
	#my $gfan_out= User::load("$tempfile.poly");
	# WARNING: file automatically converted via XSLT to correct F_VECTOR
	#return $gfan_out;
}

sub gfan_print_matrix {
  my ($tempname, $M) = @_;

  open(my $infile, ">$tempname.txt")
    or die "can't create temporary file $tempname.txt: $!";

  print $infile "{";
  my $r=$M->rows();
  my $c=$M->cols();
  for (my $i=0; $i<$r; ++$i) {
    print $infile "," unless $i==0;
    print $infile "(";
    for (my $j=0; $j<$c; ++$j) {
      print $infile "," unless $j==0;
      print $infile $M->($i,$j);
    }
      print $infile ")";
  }
  print $infile "}\n";

  close $infile;
}



sub homogenize { 
	my ($in) = @_;
	
}

sub gale_dual{
	# TODO
	return 0;
}
